# 一、概述

<img src="C:\Users\86158\AppData\Roaming\Typora\typora-user-images\image-20240510234654950.png" alt="image-20240510234654950" style="zoom: 67%;" /> 

### 1. 基本概念

- ![image-20240510235527689](C:\Users\86158\AppData\Roaming\Typora\typora-user-images\image-20240510235527689.png) 
- 关键
  - topic
  - broker
  - 分片
  - tag：目前学到是用于消息过滤的。



### 2. 系统架构

![image-20240509170237455](C:\Users\86158\AppData\Roaming\Typora\typora-user-images\image-20240509170237455.png) 

#### 2.1 注册中心

- 两个主要功能
  - Broker管理：怎么管理的？（保存信息，检查状态）
  - 路由信息管理：保存的是什么？有什么作用？（将路由信息提供给生产者和消费者）
- 三个具体有关路由的功能
  - 路由注册：为什么有这个功能？（和nameserver的无差异节点有关）这个功能是干什么用的？有什么缺陷？
    - 如何维护Broker和NameServer之间的长连接？（30秒心跳）
  - 路由剔除：是什么？会发生在什么情况下？怎么工作的？（10s扫描一次broker表，最后一次心跳超过120s则失效）
  - 路由发现：是什么？（是指客户端拉取最新保存在nameserver中的路由）
- nameserver集群下，客户端对nameserver的选择？（先随机，失败后再轮询）



#### 2.2 Broker

- 是什么？（充当中转角色...针对这一点展开，做了什么，有什么）
- 有哪些模块？
  - Remoting Module：整个Broker的实体，负责处理来自clients端的请求。
  - Client Manager：客户端管理器。
  - Store Service：存储服务。
  - HA Service：高可用服务。（用于broker主从同步）
  - Index Service：索引服务。



#### 2.3 集群部署

- Broker集群（不同Broker节点中存不同的topic），Broker节点集群（主从，由BrokerId标识主还是从）



#### 2.4 工作流程

- 从0开始描述（包括建立，注册，维护连接，创建topic；生产者获取路由，选择队列发消息，更新路由；消费者获取路由，选择队列消费消息，更新路由）
- Topic的创建模式（两种：手动（集群模式，Broker模式），自动）
- 队列可设置读写：读写队列。这样设计有个缺陷，但是为什么这样设计呢？（利用这个缺陷，方便队列缩容）



### 3. 集群搭建理论

![image-20240509191753193](C:\Users\86158\AppData\Roaming\Typora\typora-user-images\image-20240509191753193.png)

#### 3.1 数据复制与刷盘策略

- 主从复制策略：同步，异步（影响的是主机向生产者返回ACK的时间）
- 刷盘策略：是什么？用于什么？
  - 同步刷盘，异步刷盘（影响的是消息写入成功的时刻）
  - 异步刷盘具体怎么做（pagecache达到一定量自动落盘），好处？



#### 3.2 Broker集群模式

- 单Master
- 多Master：什么组成？优缺点？
- 多Master多Slave模式-异步复制：解释多主多从？解释异步复制？优缺点？
- 多Master多Slave模式-同步双写：解释同步双写？和异步复制相比，优缺点？
- 最佳实践：多Master+RAID阵
  - 优缺点？（从成本，效率，安全，数据丢失方面考虑）



### 4. 磁盘阵列RAID（补充）

- RAID是什么？
- 有哪些技术？（镜像技术，数据条带技术，数据校验技术）
- 分类（和操作系统、CPU的关联度考虑）
  - 软RAID
  - 硬RAID
  - 混合 RAID
- 等级详解（分别适用于什么场景？）
  - JBOD：串联物理磁盘
  - RAID0：无数据校验的数据条带化技术
  - RAID1：镜像技术
  - RAID10：先1后0
  - RAID01：先0后1



# 二、工作原理

<img src="C:\Users\86158\AppData\Roaming\Typora\typora-user-images\image-20240511173238426.png" alt="image-20240511173238426" style="zoom:67%;" /> 

<img src="C:\Users\86158\AppData\Roaming\Typora\typora-user-images\image-20240511173256675.png" alt="image-20240511173256675" style="zoom:67%;" /> 



### 1. 消息的生产

从发送消息之前到最终发送到消息队列的完整过程？（请求路由信息，选择queue，对消息进行处理，对broker发出RPC请求发送消息到queue）

路由信息包括什么？两个map（路由表，Broker列表），key是什么？value是什么？



### 2. Queue选择算法

有哪些？（这里是指生产者选择队列）

- 轮询算法：是什么？有什么缺点？
- 最小投递延迟算法：是什么？有什么缺点？



### 3. 消息存储

- 有哪些文件夹？都有什么内容？
  - **commitlog文件夹**
    - 存放文件名不同的mappedFile文件，名称代表当前文件第一条消息的偏移量。
    - 消息不是按照topic分类存放的，都是按照顺序写入的。因此访问效率高。
    - 消息单元中都有什么？（了解关键的就好）
  - consumequeue文件夹
    - 索引机制，便于找到每个队列的消息。按照主题分文件夹，每个主题的文件夹下，按照队列分文件。
    - 根据索引条目中的内容（偏移量CommitLog Offset，消息长度，消息Tag的hashcode值），去commitlog文件夹下对应的文件找消息即可。
      - 根据tag查询消息的具体流程
        1. 消费者会给出自己想要消费的消息的tag
        2. 对tag取hashcode，在其对应的队列文件夹下筛选出符合该hashcode的消息（但是可能会有哈希碰撞，比如不同tag对应同一个哈希，所以还要去对比tag值，确保是自己想要的消息。）
        3. 拿到这些消息的物理偏移，去commitlog中找想要的消息。
      - 根据key（业务指定的消息id）查询消息的具体流程
        - 用的是index文件，太复杂了，不说了
  - checkpoint
    - 存储着commitlog、consumequeue、index文件的最后刷盘时间戳。
    - 便于宕机恢复。
  - abort
    - 开始运行时产生，正常结束时删除，不正常结束则留下。
  - config文件夹
  - index文件夹
  - lock



### 4. 消息的消费

- 消费者获取消费类型
  - 拉取式消费
  - 推送式消费
- 消费者组消费模式
  - 广播消费：是什么？消费进度保存在哪里？应用场景？
  - 集群消费：是什么？消费进度保存在哪里？应用场景？
- Rebalance机制
  - 是什么？
  - 会出现什么问题？
    - 消息暂停：是什么？为什么？
    - 消息重复：会出现在哪种情况下？（异步提交）
    - 消息突刺：是什么？为什么？
  - 什么时候用到该机制？
    - 两方有变化时（消费者组中消费者数量变化，队列数量变化）
  - 具体过程？（根据broker中保存一些集合，包括queue信息，Consumer实例的信息。一旦这些信息发生变化，就发出Rebalance通知）
  - 保存的集合？（需要保存队列信息，消费者信息，消费offset信息）有什么作用？
- Queue分配算法（指的是队列分配给哪个消费者）
  - 四个策略
    - 平均分配
    - 环形平均
    - 一致性hash策略（类似redis中的槽分配，顺时针）
    - 同机房策略
  - 一致性hash的问题？使用场景？
- 至少一次原则
  - 是什么？
  - 什么是成功消费？
  - 什么是消费进度记录器？



### 5. 订阅关系的一致性

- 是什么？



### 6. offset管理

- 是什么？（消费进度管理）
- 有两个模式，是什么？（本地管理模式，远程管理模式）分别对应哪两个消费方式？
- 作用？
  - 用于记录消费进度...
- 对异常的消息如何处理？
  - 使用重试队列
- 集群消费模式下，有两种提交方式？（同步提交，异步提交）



### 7. 消费幂等

- 是什么？或者说是用于解决什么问题？
- 什么场景下需要用到消费幂等？（消息重复时：发送到broker时，消费时，Rebalance时）
- 解决方案
  - 幂等令牌 + 唯一性处理
  - 具体：用幂等令牌在缓存中查询，查不到再在数据库中查询，查不到说明第一次接收该消息，最后在同一事务中完成唯一性处理，写缓存，写数据库）
- 具体场景：支付场景中使用业务唯一标识，而不是Message ID（可能重复）



#### 8. 消息堆积与消费延迟

- 是什么？出现在什么场景？（上下游能力不匹配，业务系统对实时性要求高时）
- 发生该情况的真正原因？（消费耗时和消费并发度）
- 消费耗时是什么？包括哪些部分？
- 消费并发度是什么？如何提高？（纵向扩展：线程数。横向扩展：硬件资源）
- 如何避免该问题？（梳理消费耗时，设置合理的消费并发度）



#### 9. 消息的清理

- 是什么？
- 过期时间是多久？
- 发生几个情景？（从文件过期，磁盘占用率方面考虑）



## 三、应用

<img src="C:\Users\86158\AppData\Roaming\Typora\typora-user-images\image-20240511203742053.png" alt="image-20240511203742053" style="zoom: 67%;" /> 

<img src="C:\Users\86158\AppData\Roaming\Typora\typora-user-images\image-20240511203814742.png" alt="image-20240511203814742" style="zoom:67%;" /> 

<img src="C:\Users\86158\AppData\Roaming\Typora\typora-user-images\image-20240511203833482.png" alt="image-20240511203833482" style="zoom:67%;" /> 

### 1. 普通消息

- 消息发送分类（有哪些？大概流程？）
  - 同步发送消息
  - 异步发送消息
  - 单向发送消息



### 2. 顺序消息

- 是什么？
- 为什么需要？
- 有序性分为哪两个？（全局有序，分区有序）



### 3. 延时消息

- 是什么？适用哪些场景？
- 实现原理？（修改消息，根据延时等级将消息放在对应文件中SCHEDULE_TOPIC_XXXX，到时间将消息重新写入commitlog）
- 文件SCHEDULE_TOPIC_XXXX中消息如何排序的？



### 4. 事务消息

- 场景？
- 解决思路？（分布式事务XA）
  - 解决扣款过程的事务处理
  - <img src="C:\Users\86158\AppData\Roaming\Typora\typora-user-images\image-20240510214321327.png" alt="image-20240510214321327" style="zoom:50%;" /> 
- 基础知识
  - 分布式事务是什么？
  - 事务消息是什么？
  - 半事务消息是什么？
  - 消息回查是什么？
- XA模式
  - 是什么？
  - 包含三个重要组件是什么？在rocketmq中那些部分充当这三个角色
    - TC
    - TM
    - RM
- XA模式架构
  - 梳理一遍rocketmq中事务处理。
- 注意：是否支持延时消息（不），幂等检查的重要性



### 5. 批量处理

- 批量发送消息
  - 发送限制（相同的topic，相同的刷盘策略，不能包含延时消息和事务消息）
  - 发送大小限制
- 批量消费消息
  - 设置批量属性（可以设置一次最多拉取多少条消息）
  - 存在的问题：批量拉取条数越大越好吗？（不是）为什么？（从网络传输出现问题角度考虑，从消息处理异常考虑）



### 6. 消息过滤

- 是什么？
- 包括哪些方式？
  - tag过滤
  - sql过滤



### 7. 消息发送重试机制

- 是什么？保证什么？（消息不丢失）
- 什么情况下会消息重发？
- 重发可能会导致什么？（消息重复）
- 同步发送失败策略
- 异步发送失败策略
- 消息刷盘失败策略



### 8. 消息消费重试机制

- 顺序消息的消费重试（阻塞式，无休止）
- 无序消息的消费重试（重试时间间隔，达到重试上限会如何？投递到死信队列）
  - 消息重试的具体实现和延时消费相似



### 9. 死信队列

- 是什么？
- 死信队列属于哪个？（消费者组）
- 怎么处理？（开发人员特殊处理）
