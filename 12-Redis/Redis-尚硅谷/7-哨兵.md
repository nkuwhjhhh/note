## 哨兵

吹哨人巡查监控后台master主机是否故障，如果故障了根据投票数自动将某一个从库转换为新主库，继续对外服务。

![image-20240421202458184](C:\Users\86158\AppData\Roaming\Typora\typora-user-images\image-20240421202458184.png)



#### 一、用途

- 主从监控：监控主从redis库运行是否正常
- 消息通知：哨兵可以将故障转移的结果发送给客户端
- 故障转移：如果Master异常，则会进行主从切换，将其中一个Slave作为新Master
- 配置中心：客户端通过连接哨兵来获得当前Redis服务的主节点地址



#### 二、案例

具体看html讲义

简单来说就是用一个或几个哨兵监控主库，如果挂了，几个哨兵投票选举从库中的某个库作为新的主库。原来的主库回来了只能做从库了。

新的主库的配置文件中关于主库从库的设置会被修改。



#### 三、哨兵运行流程和选举原理

- 主库下线
  - 主观下线：主库自己通知自己不行了要下线
  - 客观下线：一些哨兵接收不到主库消息了，之后所有哨兵达成一致意见，认为主库不行了要将主库下线
- 选出兵王（使用的raft算法：核心思想是先到先得）
- 选出新master
  - 新主登基：在剩余健康的slave下
    - 优先选择优先级高的，如果一样，继续下面的判断
    - 优先选择offset最大的从节点（就是同步数据最多的，成为主库后使得复制代价最小的那个），如果一样，则继续下面的判断
    - 优先选择Run ID最小的（按ASCII码）
  - 群臣俯首
    - 兵王对触发对新主节点和从节点的命令：被选中的从节点执行slaveof no one，变为新的主节点，并使用slaveof命令使其他从节点变为他的从节点
  - 旧主拜服
    - 之前下线的主节点回来之后，兵王让它降级为新master的slave



#### 四、哨兵使用建议

![image-20240421220422989](C:\Users\86158\AppData\Roaming\Typora\typora-user-images\image-20240421220422989.png)
